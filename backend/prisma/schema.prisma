// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// User & Authentication
// ==========================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  passwordHash String @map("password_hash")
  
  // Profile
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  avatar    String?
  jobTitle  String?  @map("job_title")
  bio       String?
  phone     String?
  
  // Location
  locationCity    String? @map("location_city")
  locationCountry String? @map("location_country")
  timezone        String  @default("UTC")
  language        String  @default("en")
  
  // Social Links
  website     String?
  linkedinUrl String? @map("linkedin_url")
  twitterUrl  String? @map("twitter_url")
  githubUrl   String? @map("github_url")
  
  // Status
  isActive     Boolean @default(true) @map("is_active")
  isSuperAdmin Boolean @default(false) @map("is_super_admin")
  
  // Email Verification
  emailVerified   Boolean   @default(false) @map("email_verified")
  emailVerifiedAt DateTime? @map("email_verified_at")
  verificationToken String? @map("verification_token")
  
  // MFA
  mfaEnabled Boolean @default(false) @map("mfa_enabled")
  mfaSecret  String? @map("mfa_secret")
  
  // Password Reset
  resetPasswordToken  String?   @map("reset_password_token")
  resetPasswordExpires DateTime? @map("reset_password_expires")
  passwordChangedAt   DateTime? @map("password_changed_at")
  
  // Security
  failedLoginAttempts  Int       @default(0) @map("failed_login_attempts")
  lockedUntil          DateTime? @map("locked_until")
  lastLoginAt          DateTime? @map("last_login_at")
  lastLoginIp          String?   @map("last_login_ip")
  
  // Refresh Token
  refreshToken      String?   @map("refresh_token")
  refreshTokenExpiresAt DateTime? @map("refresh_token_expires_at")
  
  // Relations
  memberships       OrganizationMember[]
  invitationsSent   OrganizationInvitation[] @relation("InvitedBy")
  invitationsReceived OrganizationInvitation[] @relation("InvitedUser")
  auditLogs         AuditLog[]
  
  // Organization ownership
  ownedOrganizations Organization[] @relation("OrganizationOwner")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@map("users")
  @@index([email])
  @@index([verificationToken])
  @@index([resetPasswordToken])
  @@index([refreshToken])
}

// ==========================================
// Organization (Tenant)
// ==========================================

model Organization {
  id        String   @id @default(uuid())
  clientId  String   @unique @map("client_id")
  
  // Basic Info
  name        String
  slug        String   @unique
  description String?
  
  // URLs
  websiteUrl   String? @map("website_url")
  customDomain String? @map("custom_domain")
  
  // Branding
  logoUrl        String? @map("logo_url")
  faviconUrl     String? @map("favicon_url")
  primaryColor   String? @map("primary_color")
  secondaryColor String? @map("secondary_color")
  
  // Contact
  contactEmail String? @map("contact_email")
  contactPhone String? @map("contact_phone")
  address      String?
  
  // Subscription
  planId              String?   @map("plan_id")
  subscriptionStatus  String    @default("trial") @map("subscription_status")
  subscriptionStripeId String?  @map("subscription_stripe_id")
  trialEndsAt         DateTime? @map("trial_ends_at")
  subscriptionStartedAt DateTime? @map("subscription_started_at")
  subscriptionEndsAt  DateTime? @map("subscription_ends_at")
  currentPeriodStart  DateTime? @map("current_period_start")
  currentPeriodEnd    DateTime? @map("current_period_end")
  cancelAtPeriodEnd   Boolean   @default(false) @map("cancel_at_period_end")
  
  // Limits
  maxMembers    Int       @default(5) @map("max_members")
  storageUsedMb Int       @default(0) @map("storage_used_mb")
  maxStorageMb  Int       @default(5120) @map("max_storage_mb")
  
  // Settings
  settings Json @default("{}")
  
  // Term Settings
  defaultTermLengthYears   Int      @default(3) @map("default_term_length_years")
  maxConsecutiveTerms      Int      @default(2) @map("max_consecutive_terms")
  renewalNotificationDays  Int[]    @default([90, 60, 30]) @map("renewal_notification_days")
  autoRenewalPolicy        String   @default("opt_in") @map("auto_renewal_policy")
  enableTermTracking       Boolean  @default(true) @map("enable_term_tracking")
  
  // Status
  isActive Boolean @default(true) @map("is_active")
  
  // Relations
  createdBy String @map("created_by")
  owner     User   @relation("OrganizationOwner", fields: [createdBy], references: [id])
  
  members      OrganizationMember[]
  invitations  OrganizationInvitation[]
  auditLogs    AuditLog[]
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@map("organizations")
  @@index([slug])
  @@index([clientId])
  @@index([customDomain])
}

// ==========================================
// Organization Membership
// ==========================================

model OrganizationMember {
  id        String   @id @default(uuid())
  
  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Role (RBAC)
  role       String
  department String?
  title      String?
  
  // Status
  isActive Boolean @default(true) @map("is_active")
  
  // Invitation Tracking
  joinedAt DateTime @default(now()) @map("joined_at")
  lastActiveAt DateTime? @map("last_active_at")
  invitedBy String? @map("invited_by")
  invitedAt DateTime? @map("invited_at")
  
  // Term Tracking
  termStartDate DateTime? @map("term_start_date")
  termEndDate   DateTime? @map("term_end_date")
  termLengthYears Int?    @map("term_length_years")
  renewalNotifiedAt DateTime? @map("renewal_notified_at")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([organizationId, userId])
  @@map("organization_members")
  @@index([organizationId])
  @@index([userId])
  @@index([role])
}

// ==========================================
// Organization Invitations
// ==========================================

model OrganizationInvitation {
  id        String   @id @default(uuid())
  
  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  email String
  role  String
  department String?
  title      String?
  
  // Security
  tokenHash String @map("token_hash")
  expiresAt DateTime @map("expires_at")
  
  // Status
  acceptedAt DateTime? @map("accepted_at")
  acceptedBy String?   @map("accepted_by")
  cancelledAt DateTime? @map("cancelled_at")
  
  // Term Settings
  termLengthYears Int?      @map("term_length_years")
  termStartDate   DateTime? @map("term_start_date")
  
  // Relations
  invitedBy String @map("invited_by")
  inviter   User   @relation("InvitedBy", fields: [invitedBy], references: [id])
  
  acceptedUser User? @relation("InvitedUser", fields: [acceptedBy], references: [id])
  
  // Timestamps
  invitedAt DateTime @default(now()) @map("invited_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("organization_invitations")
  @@index([organizationId])
  @@index([email])
  @@index([tokenHash])
  @@index([expiresAt])
}

// ==========================================
// Audit Log
// ==========================================

model AuditLog {
  id        String   @id @default(uuid())
  
  organizationId String?       @map("organization_id")
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  
  userId String? @map("user_id")
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Action Details
  action       String @map("action")
  resourceType String @map("resource_type")
  resourceId   String? @map("resource_id")
  details      Json?
  
  // Context
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  @@map("audit_logs")
  @@index([organizationId])
  @@index([userId])
  @@index([action])
  @@index([resourceType])
  @@index([createdAt])
}

// ==========================================
// Subscription Plans (for reference)
// ==========================================

model SubscriptionPlan {
  id        String   @id @default(uuid())
  
  name        String
  slug        String  @unique
  description String?
  
  // Pricing
  priceMonthly Int @map("price_monthly")
  priceYearly  Int @map("price_yearly")
  
  // Limits
  maxUsers      Int @map("max_users")
  maxStorageMb  Int @map("max_storage_mb")
  maxCommittees Int @map("max_committees")
  
  // Features
  features Json?
  
  // Stripe
  stripePriceIdMonthly String? @map("stripe_price_id_monthly")
  stripePriceIdYearly  String? @map("stripe_price_id_yearly")
  
  // Status
  isActive   Boolean @default(true) @map("is_active")
  isPopular  Boolean @default(false) @map("is_popular")
  sortOrder  Int     @default(0) @map("sort_order")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("subscription_plans")
}
